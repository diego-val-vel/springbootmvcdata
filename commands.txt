# Levantar los contenedores
docker compose up -d

# Acceder al contenedor de desarrollo
docker compose exec springdev bash

# Dentro del contenedor: preparar entorno
apt-get update
apt-get upgrade -y
apt-get install -y curl wget git unzip zip ca-certificates gnupg software-properties-common build-essential apt-transport-https fontconfig httpie jq postgresql-client
apt-get install -y openjdk-21-jdk maven gradle

# Variables de entorno para Java
echo 'export JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64' >/etc/profile.d/java.sh
echo 'export PATH=$JAVA_HOME/bin:$PATH' >>/etc/profile.d/java.sh
. /etc/profile.d/java.sh

# Verificar herramientas Java/Maven
java -version
mvn -version

# Instalar Node.js 20
curl -fsSL https://deb.nodesource.com/setup_20.x -o /tmp/nodesource_setup.sh
bash /tmp/nodesource_setup.sh
apt-get install -y nodejs
node -v

# Compilar proyecto
mvn -q -DskipTests package

# ===
# Uso de perfiles
# ===

# Default
mvn spring-boot:run

# Test
mvn spring-boot:run -Dspring-boot.run.profiles=test

# Prod
mvn spring-boot:run -Dspring-boot.run.profiles=prod

# ===
# Práctica 2
# ===

# Cambiarse a la rama
cd /springbootmvcdata
git checkout feature/practica2

# Dentro del contenedor
cd /workspace
mvn spring-boot:run

# Probar /actuator/health desde el host
curl http://localhost:8080/actuator/health

# Probar creación de pre-reserva (caso correcto)
curl -i \
  -H "Content-Type: application/json" \
  -d '{
    "guestName": "Juan Pérez",
    "roomType": "STANDARD",
    "numberOfNights": 3
  }' \
  http://localhost:8080/api/pre-bookings

# Probar validación (error de Bean Validation), nombre vacío y noches 0
curl -i \
  -H "Content-Type: application/json" \
  -d '{
    "guestName": "",
    "roomType": "STANDARD",
    "numberOfNights": 0
  }' \
  http://localhost:8080/api/pre-bookings

# Probar consulta por id (caso encontrado)
curl -i http://localhost:8080/api/pre-bookings/1

# Probar consulta por id inexistente (BookingNotFoundException)
curl -i http://localhost:8080/api/pre-bookings/999

# ===
# Práctica 3
# ===

###
# Parte 1
###

# Cambiarse a la rama
cd /springbootmvcdata
git checkout feature/practica3_pt1

# Dentro del contenedor
cd /workspace
./mvnw spring-boot:run

# Listar habitaciones
curl -i http://localhost:8080/api/rooms

# Crear habitación (correctas)
curl -i -X POST http://localhost:8080/api/rooms \
  -H "Content-Type: application/json" \
  -d '{
    "code": "STD-101",
    "name": "Standard King",
    "capacity": 2,
    "basePricePerNight": 1500.00
  }'

curl -i -X POST http://localhost:8080/api/rooms \
  -H "Content-Type: application/json" \
  -d '{
    "code": "DLX-201",
    "name": "Deluxe Queen",
    "capacity": 3,
    "basePricePerNight": 2200.00
  }'

# Consultar habitación
curl -i http://localhost:8080/api/rooms/1

# Actualizar habitación
curl -i -X PUT http://localhost:8080/api/rooms/1 \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Standard King Renovada",
    "capacity": 2,
    "basePricePerNight": 1800.00,
    "active": false
  }'

# Eliminar habitación
curl -i -X DELETE http://localhost:8080/api/rooms/2

# Crear habitaciones (incorrectas)
curl -i -X POST http://localhost:8080/api/rooms \
  -H "Content-Type: application/json" \
  -d '{
    "code": "ERR-001",
    "name": "",
    "capacity": 2,
    "basePricePerNight": 1000.00
  }'

curl -i -X POST http://localhost:8080/api/rooms \
  -H "Content-Type: application/json" \
  -d '{
    "code": "ERR-002",
    "name": "Capacidad Cero",
    "capacity": 0,
    "basePricePerNight": 1000.00
  }'

curl -i -X POST http://localhost:8080/api/rooms \
  -H "Content-Type: application/json" \
  -d '{
    "code": "STD-101",
    "name": "Standard King Duplicada",
    "capacity": 2,
    "basePricePerNight": 1500.00
  }'

###
# Parte 2
###

# Cambiarse a la rama
cd /springbootmvcdata
git checkout feature/practica3_pt2

# Dentro del contenedor
cd /workspace
./mvnw spring-boot:run

# Crear habitación
curl -i -X POST http://localhost:8080/api/rooms \
  -H "Content-Type: application/json" \
  -d '{
    "code": "STD-101",
    "name": "Standard King",
    "capacity": 2,
    "basePricePerNight": 1500.00
  }'

curl -i -X POST http://localhost:8080/api/rooms \
  -H "Content-Type: application/json" \
  -d '{
    "code": "DLX-201",
    "name": "Deluxe Queen",
    "capacity": 3,
    "basePricePerNight": 2200.00
  }'

# Verificar listado JSON y el cambio de nombre de propiedad (pricePerNight)
curl -i http://localhost:8080/api/rooms

# Thymeleaf

# Listado HTML
curl -i http://localhost:8080/rooms

# Detalle HTML rooms
curl -i http://localhost:8080/rooms/1
curl -i http://localhost:8080/rooms/2

# Detalle HTML rooms (vía browser)
http://localhost:8080/rooms

# Verificar que el campo interno no se expone en JSON
# Modificar el RoomService.createRoom para asignar un valor en las notas internas.

curl -i -X POST http://localhost:8080/api/rooms \
  -H "Content-Type: application/json" \
  -d '{
    "code": "INT-999",
    "name": "Habitación con notas internas",
    "capacity": 2,
    "basePricePerNight": 1234.50
  }'

# Verificar la room con notas
curl -i http://localhost:8080/api/rooms

# ===
# Práctica 4
# ===

# Cambiarse a la rama
cd /springbootmvcdata
git checkout feature/practica4

# Dentro del contenedor
cd /workspace
./mvnw spring-boot:run

# Crear una habitación desde la vista
http://localhost:8080/rooms/new

-- Habitación 1
Code: STD-101
Name: Standard King
Capacity: 2
Base price per night: 1500.00
Active: marcado

-- Habitación 2
Code: DLX-201
Name: Deluxe Double
Capacity: 4
Base price per night: 2500.00
Active: marcado

-- Habitación 3
Code: SUI-301
Name: Junior Suite
Capacity: 3
Base price per night: 3200.00
Active: marcado

# Ver listado
http://localhost:8080/rooms

# Ver detalle de una habitación
http://localhost:8080/rooms/1

# Editar una habitación
http://localhost:8080/rooms/1/edit

# Cambio de idiomas
http://localhost:8080/rooms?lang=es
http://localhost:8080/rooms?lang=en

# Crear varias habitaciones y probar lo siguiente.
http://localhost:8080/rooms?size=2
http://localhost:8080/rooms?size=2&page=1
http://localhost:8080/rooms?size=2&sort=code&dir=asc
http://localhost:8080/rooms?size=2&sort=price&dir=desc